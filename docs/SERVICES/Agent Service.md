# Agent Service

---

## Description

**Agent Service** — это оркестратор пользовательских запросов, работающий поверх заметок и векторного поиска.  
Он интерпретирует запрос пользователя, планирует последовательность действий (_ручек_), выполняет их через Notes Service и Retrieval, а затем формирует итоговый ответ.

Agent Service не хранит данные и не имеет прямого доступа к основной БД.

---

## Responsibility

- Приём пользовательских запросов (через Client)
- Хранение контекстов
- Интерпретация намерений пользователя
- Построение плана действий (sequence of actions)
- Вызов внутренних _ручек_ (tools)
- Использование векторного поиска для контекста
- Формирование финального ответа
- Генерация списка выполненных **Actions** для UI (undo / audit)

---

## Non-Responsibilities

- Не читает и не пишет напрямую в Notes DB
- Не хранит заметки
- Не индексирует данные
- Не занимается авторизацией
- Не принимает решения о персистентности данных

---

## Inputs

- Пользовательский запрос (natural language)
- Контекст чата
- Метаданные текущей сессии (user_id, note_id и т.п.)

---

## Outputs

- Текстовый ответ пользователю
- Список выполненных **Actions** (структурированный)
- Служебные данные для клиента (например, изменения состояния)

---

## Internal Concepts

### Tools / Actions

Agent работает только через ограниченный набор _ручек_ **(ПРИМЕРНЫЙ)**:

- `search_notes(query, filters)`
- `get_note(note_id)`
- `update_note(note_id, patch)`
- `delete_notes(filter)`
- `list_notes(filter)`
- `get_chat_history(context_id)`

Agent **не знает**, как именно они реализованы.

---

## Processing Flow (approximate)

1. Получение запроса от клиента
2. Анализ намерений
3. Формирование плана действий
4. Последовательное выполнение _ручек_
5. Сбор результатов
6. Генерация финального ответа
7. Возврат ответа и списка Actions клиенту

---

## Safety & Control

- Все действия обратимы (через Actions / InverseActions)
- Удаления — логические (trash)
- Агент не выполняет разрушительных операций напрямую
- Возможность клиентского подтверждения и undo

---

## Consistency Model

- Работает с уже синхронизированными данными
- Не требует строгой консистентности
- Допускает задержку между изменением заметки и появлением в поиске

---

## Failure Handling

- Ошибки отдельных действий не приводят к падению сервиса
- План может быть частично выполнен
- Клиент получает фактически выполненные Actions

---

## Storage

- Не имеет собственной БД
- Контексты чатов Redis / MongoDB

---

## Stack

- **FastAPI** — HTTP / WebSocket
- **uvicorn** — ASGI сервер
- Async HTTP/RPC **клиенты для Notes Service и Vector DB**
- **LLM** — планирование и генерация текста
- **JSON-based Action protocol**
- **Redis / MongoDB** для хранения контекстов чата