# Notes Service

---

## Description

Notes Service — доменный сервис управления пользовательскими заметками.  
Является **единственным источником истины** для состояния заметок и **единственным сервисом**, имеющим право их модифицировать.

Сервис оптимизирован под частые изменения контента (редактирование в реальном времени) и использует событийную модель для уведомления других сервисов о произошедших изменениях.

---

## Responsibilities

- Создание, чтение, обновление и удаление заметок (CRUD)
- Управление сессиями редактирования (Editing Sessions)
- Приём частых изменений от клиента
- Дебаунс и батчинг записей в основную БД
- Обеспечение целостности данных заметок
- Проверка прав доступа к заметкам (на уровне домена)
- Публикация доменных событий через Outbox

---

## Non-Responsibilities

Notes Service **не отвечает** за:
- Векторизацию текста
- Поиск и retrieval
- Хранение эмбеддингов
- Синхронизацию с Vector DB
- Оркестрацию агентов
- Аутентификацию пользователей (только валидация JWT)
---

## Editing Model

- Клиент может отправлять изменения каждые 1–2 секунды
- Notes Service:
    - принимает изменения
    - временно удерживает их в памяти / кэше
    - агрегирует изменения в рамках Editing Session
    - Делает батчевую запись в DB
- Editing Session:
    - существует только внутри Notes Service
    - не является внешним API-контрактом

---

## Event Model

Notes Service использует **Outbox Pattern**.

### Принцип

- Все изменения данных:
    - записываются в Notes DB
    - **в той же транзакции** фиксируются в Outbox
- Сервис **не отправляет события напрямую** другим сервисам

### Типы событий

- `NoteCreated`
- `NoteUpdated`
- `NoteDeleted`
- `NoteRestored`
- `NoteCompletelyRemoved`

Outbox используется внешними сервисами (например, Sync Service) для реактивной обработки изменений.

---

## Data Ownership & Access

- **Notes DB**
    - Полный доступ (Read / Write)
- **Outbox**
    - Write-only

Другие сервисы:
- не имеют доступа к Notes DB
- получают информацию о изменениях только через события

---

## API Consumers

- **Client Service**
    - CRUD-операции
    - редактирование заметок
- **Agent Service**
    - чтение заметок
    - инициирование изменений (через API Notes Service)

---

## Failure Semantics

- Падение Notes Service:
    - не нарушает целостность Notes DB
    - возможна потеря несброшенных данных текущей Editing Session
- После рестарта:
    - состояние восстанавливается из Notes DB
    - события дочитываются через Outbox

---

## Security Model

- Клиент не имеет прямого доступа к БД
- Все запросы проходят через Notes Service
- JWT используется для:
    - идентификации пользователя
    - проверки прав доступа к заметкам

---

## Stack (предполагаемый)

- **FastAPI**
- **PostgreSQL** (Notes DB)
- **Transactional Outbox** (таблица в Notes DB)
- **Redis** (для Editing Sessions)