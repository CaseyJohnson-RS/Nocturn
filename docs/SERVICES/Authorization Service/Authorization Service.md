# Authorization Service

---

## Описание

Authorization Service отвечает исключительно за аутентификацию и авторизацию пользователей. Работает по модели **JWT + Refresh Token Rotation**. Является единственным источником истины для пользовательских сессий.
```columns
id: baA64AmsP_WIAOEtFgNgH
===
#### Ответственнен

- Регистрация и аутентификация пользователей
- Выдача Access JWT и Refresh Token
- Ротация refresh tokens
- Отзыв отдельных сессий и всех сессий пользователя
- Подтверждение email
- Восстановление пароля
- Бан и разбан пользователей
- Детекция компрометации сессий
- Уведомление о подозрительной активности
===
#### НЕ Ответственнен
- Хранение пользовательских данных, не связанных с авторизацией
- Бизнес-логика приложений
- Управление прав
```
**Стек**

- FastAPI
- PostgreSQL (Auth DB)
- JWT (RS256)

---

## Модель авторизации
```columns
id: TAFqS7Ooi_24Nk2mkSyLx
===
#### Access Token (JWT)
  - Короткий TTL (10 минут)
  - Не хранится в БД
  - Используется для доступа к защищённым ресурсам
===
#### Refresh Token
  - Длинный TTL (14 дней)
  - Хранится в Auth DB (в хэшированном виде)
  - Одноразовый
  - Подлежит ротации при каждом использовании

```
**Гарантии по токенам**

- Access Token может истечь в любой момент
- Refresh Token может быть использован только один раз
- Использование отозванного refresh token считается компрометацией
- При подтверждении компрометации:
  - вся цепочка refresh tokens отзывается
  - все связанные сессии инвалидируются

**Доверительная модель**

- Только Authorization Service имеет право:
  - выпускать токены
  - отзывать сессии
- Остальные сервисы:
  - валидируют Access JWT
  - не знают о refresh tokens

**Вопросы безопасности**

 - Все токены хранятся в хешированном виде
 - Пароли хранятся в хешированном виде
 - JWT подписываются приватным ключом
 - Сервисы доверяют подписи JWT
 - Auth DB недоступна другим сервисам

---

## Сценарии пользования

**Основные**

1. **Register** — регистрация нового пользователя
2. **Verify Email** — подтверждение email
3. **Login** — вход с выдачей JWT + Refresh Token
4. **Logout (Single Session)** — выход из текущей сессии
5. **Logout (All Sessions)** — выход со всех устройств
6. **Password Reset Request** — запрос сброса пароля
7. **Password Reset Confirm** — подтверждение нового пароля

**Токен и сессии**

8. **Access Token Expiration** — обработка истечения JWT
9. **Refresh Token Rotation** — безопасная ротация refresh токена
10. **Refresh Token Expiration** — истечение refresh токена
11. **Refresh Token Reuse Detected** — обнаружение повторного использования refresh токена

**Безопасность / ограничения**

12. **User Banned** — бан/разбан пользователя
13. **Suspicious Login / IP Monitoring** — фиксация подозрительных действий

**Auditing / события**

14. **Security Events Logging** — логирование событий безопасности (login/logout/reset/refresh) 
15. **Token Revocation** — отзыв токенов по требованию или безопасности
16. **Session Expiry Cleanup** — периодическая очистка устаревших токенов

---

